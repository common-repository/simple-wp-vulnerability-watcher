<?php

/**
 * Plugin Name: Simple WP Vulnerability Watcher
 * Plugin URI: https://simplecode.cz/wordpress/plugins
 * Description: A lightweight security plugin that scans installed plugins, themes, and WordPress core for known vulnerabilities.
 * Version: 1.0
 * Author: Simplecode.cz
 * Author URI: https://ko-fi.com/codestorm
 * License: GPLv2
 * License URI: https://www.gnu.org/licenses/gpl-3.0.html
 * Text Domain: simple-wp-vulnerability-watcher
 * Domain Path: /languages
 */

if (!defined('ABSPATH')) {
    exit; // Prevent direct access if accessed outside of WordPress
}

// Include the main functions file, where all plugin logic is defined
require_once plugin_dir_path(__FILE__) . 'includes/wpcv-functions.php';

// Enqueue admin scripts and styles
function wpcv_enqueue_admin_assets()
{
    // Enqueue custom CSS file
    wp_enqueue_style('wpcv-styles', plugin_dir_url(__FILE__) . 'css/admin-styles.css', array(), '1.0');

    // Enqueue custom JavaScript file
    wp_enqueue_script('wpcv-scripts', plugin_dir_url(__FILE__) . 'js/admin-scripts.js', array('jquery'), '1.0', true);

    // Localize script with AJAX URL and nonce for security
    wp_localize_script('wpcv-scripts', 'wpcv_vars', array(
        'ajax_url' => admin_url('admin-ajax.php'),  // AJAX URL
        'nonce'    => wp_create_nonce('wpcv_dismiss_notice_nonce')  // Nonce for verification
    ));
}
add_action('admin_enqueue_scripts', 'wpcv_enqueue_admin_assets');

// Add "Check Now" button and settings link to the plugin actions (next to "Deactivate")
function wpcv_add_settings_link($actions, $plugin_file)
{
    // Check if the current plugin is ours
    if ($plugin_file == plugin_basename(__FILE__)) {
        // Add the "Check Now" button that links to the plugin page
        $check_now = array(
            'check_now' => '<a href="' . admin_url('admin.php?page=check-vulnerabilities') . '" style="color: green; font-weight: bold;">' . __('Check Now', 'simple-wp-vulnerability-watcher') . '</a>'
        );

        // Add "Check Now" to the actions (which already include "Deactivate")
        $actions = array_merge($actions, $check_now);
    }

    return $actions;
}
// Hook into the plugin action links to add "Check Now"
add_filter('plugin_action_links_' . plugin_basename(__FILE__), 'wpcv_add_settings_link', 10, 2);

// Add custom meta links (Donate) to the plugin's metadata (under plugin description)
function wpcv_add_meta_links($links, $file)
{
    // Check if the current plugin is ours
    if ($file == plugin_basename(__FILE__)) {
        // Add the "Donate" link to the meta information
        $new_links = array(
            '<a href="https://ko-fi.com/codestorm" target="_blank" style="color: #ff5c5c; font-weight: bold;">' . __('Donate', 'simple-wp-vulnerability-watcher') . '</a>'
        );

        // Merge the "Donate" link with the existing meta links
        $links = array_merge($links, $new_links);
    }

    return $links;
}
// Hook into the plugin metadata to add the "Donate" link
add_filter('plugin_row_meta', 'wpcv_add_meta_links', 10, 2);
